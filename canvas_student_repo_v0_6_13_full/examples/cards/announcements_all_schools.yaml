type: markdown
title: Announcements (All Schools)
content: |-
  {%- set ns_global = namespace(shown=0) -%}
  {%- set fmt = '%b %d, %I:%M %p' -%}
  {%- for s in states.sensor | sort(attribute='entity_id') -%}
    {%- set eid = s.entity_id -%}
    {%- if eid.startswith('sensor.canvas_') and eid.endswith('_student_announcements') -%}
      {%- set anns   = state_attr(eid,'announcements') or [] -%}
      {%- set cnb    = state_attr(eid,'course_names_by_id') or {} -%}
      {%- set base   = state_attr(eid,'base_url') or '' -%}
      {%- set school = state_attr(eid,'school_name') or 'Canvas' -%}
      {%- set hide   = state_attr(eid,'hide_empty') or false -%}
      {%- set total = anns | count -%}
      {%- if not (hide and total == 0) -%}
  <h3>{{ school }}</h3>
        {%- if total == 0 -%}
  _No recent announcements._<br>
        {%- else -%}
          {%- set last = namespace(cid=None) -%}
          {%- for a in anns | sort(attribute='course_id') -%}
            {%- if a.course_id != last.cid -%}
              {%- set last.cid = a.course_id -%}
  <strong><a href="{{ base }}/courses/{{ a.course_id }}">{{ cnb.get((a.course_id|string), a.course_id) }}</a></strong><br>
            {%- endif -%}
  • <a href="{{ a.html_url }}">{{ a.title }}</a>{% if a.posted_at %} — {{ as_timestamp(as_datetime(a.posted_at)) | timestamp_custom(fmt, true) }}{% endif %}<br>
          {%- endfor -%}
  <br>
        {%- endif -%}
        {%- set ns_global.shown = ns_global.shown + 1 -%}
      {%- endif -%}
    {%- endif -%}
  {%- endfor -%}
  {%- if ns_global.shown == 0 -%}
  _No Canvas announcement sensors found._
  {%- endif -%}
