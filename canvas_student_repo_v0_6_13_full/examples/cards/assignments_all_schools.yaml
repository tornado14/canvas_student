type: markdown
title: Upcoming Assignments (All Schools)
content: |-
  {%- set ns_global = namespace(shown=0) -%}
  {%- set fmt = '%b %d, %I:%M %p' -%}
  {%- for s in states.sensor | sort(attribute='entity_id') -%}
    {%- set eid = s.entity_id -%}
    {%- if eid.startswith('sensor.canvas_') and eid.endswith('_student_assignments') -%}
      {%- set abyc   = state_attr(eid,'assignments_by_course') or {} -%}
      {%- set cnb    = state_attr(eid,'course_names_by_id') or {} -%}
      {%- set base   = state_attr(eid,'base_url') or '' -%}
      {%- set school = state_attr(eid,'school_name') or 'Canvas' -%}
      {%- set hide   = state_attr(eid,'hide_empty') or false -%}
      {%- set grades_eid = (eid | replace('_assignments','_grades')) -%}
      {%- set gmap   = state_attr(grades_eid,'grades_by_course') or {} -%}
      {%- set gurls  = state_attr(grades_eid,'grade_urls_by_course') or {} -%}
      {%- set info_eid = (eid | replace('_assignments','_info')) -%}
      {%- set credits = state_attr(info_eid,'credits_by_course') or {} -%}
      {%- set gpa    = state_attr(info_eid,'gpa') -%}
      {%- set ns = namespace(total=0) -%}
      {%- for _cid, items in abyc.items() -%}{% set ns.total = ns.total + (items | count) %}{%- endfor -%}
      {%- if not (hide and ns.total == 0) -%}
  <h3>{{ school }}{% if gpa is number %} — GPA: {{ (gpa | round(3)) }}{% endif %}</h3>
        {%- if ns.total == 0 -%}
  _No upcoming assignments._<br>
        {%- else -%}
          {%- for cid, items in abyc.items() | sort -%}
            {%- if not (hide and (items | count == 0)) -%}
              {%- set g = gmap.get(cid) -%}
              {%- set score  = (g.current_score if g and (g.current_score is not none) else none) -%}
              {%- set letter = (g.current_grade if g and g.current_grade else none) -%}
              {%- set grade_text = (letter ~ ' (' ~ (score | round(1)) ~ '%)') if (letter and score is not none)
                                   else ((score | round(1) ~ '%') if (score is not none)
                                   else (letter if letter else none)) -%}
              {%- set gurl = gurls.get(cid) -%}
              {%- set cr = credits.get(cid) -%}
  <strong><a href="{{ base }}/courses/{{ cid }}">{{ cnb.get(cid, cid) }}</a></strong>
  — {{ items|count }}{% if cr %} • {{ cr }} cr{% endif %}{% if grade_text %}
  — Grade: {% if gurl %}<a href="{{ gurl }}">{{ grade_text }}</a>{% else %}{{ grade_text }}{% endif %}{% elif gurl %} — <a href="{{ gurl }}">Gradebook</a>{% endif %}<br>
              {%- for a in items -%}
  • <a href="{{ a.html_url }}">{{ a.name }}</a>{% if a.due_at %} — {{ as_timestamp(as_datetime(a.due_at)) | timestamp_custom(fmt, true) }}{% endif %}<br>
              {%- endfor -%}
  <br>
            {%- endif -%}
          {%- endfor -%}
        {%- endif -%}
        {%- set ns_global.shown = ns_global.shown + 1 -%}
      {%- endif -%}
    {%- endif -%}
  {%- endfor -%}
  {%- if ns_global.shown == 0 -%}
  _No Canvas assignment sensors found._
  {%- endif -%}
