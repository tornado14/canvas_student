type: markdown
title: Upcoming Assignments (All Schools)
content: |-
  {%- set ns_global = namespace(shown=0) -%}
  {%- set fmt = '%b %d, %I:%M %p' -%}
  {%- for s in states.sensor | sort(attribute='entity_id') -%}
    {%- set eid = s.entity_id -%}
    {%- if eid.startswith('sensor.canvas_') and eid.endswith('_student_assignments') -%}
      {%- set abyc   = state_attr(eid, 'assignments_by_course') or {} -%}
      {%- set cnb    = state_attr(eid, 'course_names_by_id') or {} -%}
      {%- set base   = state_attr(eid, 'base_url') or '' -%}
      {%- set school = state_attr(eid, 'school_name') or 'Canvas' -%}
      {%- set hide   = state_attr(eid, 'hide_empty') or false -%}
      {%- set ns = namespace(total=0) -%}
      {%- for _cid, items in abyc.items() -%}{% set ns.total = ns.total + (items | count) %}{%- endfor -%}
      {%- if not (hide and ns.total == 0) -%}
  <h3>{{ school }}</h3>
        {%- if ns.total == 0 -%}
  _No upcoming assignments._<br>
        {%- else -%}
          {%- for cid, items in abyc.items() | sort -%}
            {%- if not (hide and (items | count == 0)) -%}
  <strong><a href="{{ base }}/courses/{{ cid }}">{{ cnb.get(cid, cid) }}</a></strong> — {{ items|count }}<br>
              {%- for a in items -%}
  • <a href="{{ a.html_url }}">{{ a.name }}</a>{% if a.due_at %} — {{ as_timestamp(as_datetime(a.due_at)) | timestamp_custom(fmt, true) }}{% endif %}<br>
              {%- endfor -%}
  <br>
            {%- endif -%}
          {%- endfor -%}
        {%- endif -%}
        {%- set ns_global.shown = ns_global.shown + 1 -%}
      {%- endif -%}
    {%- endif -%}
  {%- endfor -%}
  {%- if ns_global.shown == 0 -%}
  _No Canvas assignment sensors found._
  {%- endif -%}
